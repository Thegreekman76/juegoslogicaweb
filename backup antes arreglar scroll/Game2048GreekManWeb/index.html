<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ 2048 - Puzzle Game</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 25%, #16a085 50%, #27ae60 75%, #2ecc71 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 36px;
            background: linear-gradient(45deg, #00F5FF, #00CED1, #20B2AA);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
            animation: glow 3s ease-in-out infinite alternate;
        }
        
        .subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(0, 245, 255, 0.3); }
            to { text-shadow: 0 0 30px rgba(0, 245, 255, 0.6); }
        }
        
        .game-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #00F5FF;
        }
        
        .mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .mode-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            min-width: 80px;
        }
        
        .mode-btn.active {
            background: linear-gradient(45deg, #00F5FF, #20B2AA);
            color: #1e3c72;
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.4);
        }
        
        .mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .difficulty-toggle {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            margin: 0 10px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            transition: 0.3s;
            border-radius: 30px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(45deg, #00F5FF, #20B2AA);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .game-board {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        
        .grid {
            display: grid;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 15px;
            position: relative;
        }
        
        .grid-3x3 { grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); }
        .grid-4x4 { grid-template-columns: repeat(4, 70px); grid-template-rows: repeat(4, 70px); }
        .grid-5x5 { grid-template-columns: repeat(5, 60px); grid-template-rows: repeat(5, 60px); }
        .grid-6x6 { grid-template-columns: repeat(6, 50px); grid-template-rows: repeat(6, 50px); }
        
        .cell {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.2s ease;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tile {
            position: absolute;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 32px;
            transition: all 0.15s ease;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            cursor: grab;
        }
        
        .tile:active {
            cursor: grabbing;
        }
        
        .tile.new {
            animation: appear 0.2s ease;
        }
        
        .tile.merged {
            animation: merge 0.3s ease;
        }
        
        @keyframes appear {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes merge {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Gradientes din√°micos para diferentes valores */
        .tile-2 { background: linear-gradient(135deg, #E8F8F5, #D5F4E6); color: #1e3c72; font-size: 32px; }
        .tile-4 { background: linear-gradient(135deg, #D5F4E6, #ABEBC6); color: #1e3c72; font-size: 32px; }
        .tile-8 { background: linear-gradient(135deg, #ABEBC6, #82E0AA); color: #1e3c72; font-size: 32px; }
        .tile-16 { background: linear-gradient(135deg, #82E0AA, #58D68D); color: white; font-size: 30px; }
        .tile-32 { background: linear-gradient(135deg, #58D68D, #2ECC71); color: white; font-size: 30px; }
        .tile-64 { background: linear-gradient(135deg, #2ECC71, #27AE60); color: white; font-size: 30px; }
        .tile-128 { background: linear-gradient(135deg, #27AE60, #229954); color: white; font-size: 28px; }
        .tile-256 { background: linear-gradient(135deg, #229954, #1E8449); color: white; font-size: 28px; }
        .tile-512 { background: linear-gradient(135deg, #1E8449, #196F3D); color: white; font-size: 28px; }
        .tile-1024 { background: linear-gradient(135deg, #17A2B8, #138496); color: white; font-size: 26px; }
        .tile-2048 { background: linear-gradient(135deg, #007BFF, #0056B3); color: white; font-size: 26px; animation: celebrate 1s ease infinite alternate; }
        .tile-4096 { background: linear-gradient(135deg, #6F42C1, #5A2D91); color: white; font-size: 24px; }
        .tile-8192 { background: linear-gradient(135deg, #E83E8C, #C2185B); color: white; font-size: 22px; }
        
        @keyframes celebrate {
            0% { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 123, 255, 0.5); }
            100% { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 0 30px rgba(0, 123, 255, 0.8); }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 8px;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #00F5FF, #20B2AA);
            color: #1e3c72;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6C757D, #ADB5BD);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #2ECC71, #27AE60);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #F39C12, #E67E22);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #E74C3C, #C0392B);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .instructions {
            background: rgba(0, 245, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #00F5FF;
        }
        
        .instructions h3 {
            color: #00F5FF;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .instructions p {
            font-size: 14px;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }
        
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .game-over.show {
            display: flex;
        }
        
        .game-over-content {
            background: linear-gradient(145deg, #1e3c72, #2a5298);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 245, 255, 0.3);
        }
        
        .game-over h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #00F5FF;
            text-shadow: 0 0 15px rgba(0, 245, 255, 0.6);
        }
        
        .game-over p {
            font-size: 16px;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            padding: 20px;
        }
        
        .help-modal.show {
            display: flex;
        }
        
        .help-content {
            background: linear-gradient(145deg, #1e3c72, #2a5298);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid rgba(0, 245, 255, 0.3);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        
        .help-content h2 {
            color: #00F5FF;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }
        
        .help-section {
            margin-bottom: 25px;
        }
        
        .help-section h3 {
            color: #20B2AA;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .help-section p, .help-section li {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .help-section ul {
            padding-left: 20px;
        }
        
        .controls-demo {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .keyboard-keys {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .key {
            background: linear-gradient(45deg, #00F5FF, #20B2AA);
            color: #1e3c72;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        
        .close-help {
            background: linear-gradient(45deg, #E74C3C, #C0392B);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .title {
                font-size: 28px;
            }
            
            .grid-3x3 { grid-template-columns: repeat(3, 70px); grid-template-rows: repeat(3, 70px); }
            .grid-4x4 { grid-template-columns: repeat(4, 60px); grid-template-rows: repeat(4, 60px); }
            .grid-5x5 { grid-template-columns: repeat(5, 50px); grid-template-rows: repeat(5, 50px); }
            .grid-6x6 { grid-template-columns: repeat(6, 42px); grid-template-rows: repeat(6, 42px); }
            
            .tile {
                font-size: 28px;
            }
            
            .tile-2, .tile-4, .tile-8 {
                font-size: 28px;
            }
            
            .tile-16, .tile-32, .tile-64 {
                font-size: 26px;
            }
            
            .tile-128, .tile-256, .tile-512 {
                font-size: 24px;
            }
            
            .tile-1024, .tile-2048 {
                font-size: 22px;
            }
            
            .tile-4096, .tile-8192 {
                font-size: 20px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                min-width: auto;
            }
            
            .mode-selector {
                gap: 5px;
            }
            
            .mode-btn {
                font-size: 10px;
                padding: 6px 8px;
                min-width: 60px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-3x3 { grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px); }
            .grid-4x4 { grid-template-columns: repeat(4, 50px); grid-template-rows: repeat(4, 50px); }
            .grid-5x5 { grid-template-columns: repeat(5, 42px); grid-template-rows: repeat(5, 42px); }
            .grid-6x6 { grid-template-columns: repeat(6, 35px); grid-template-rows: repeat(6, 35px); }
            
            .tile {
                font-size: 24px;
            }
            
            .tile-128, .tile-256, .tile-512 {
                font-size: 20px;
            }
            
            .tile-1024, .tile-2048, .tile-4096, .tile-8192 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üéÆ 2048</h1>
            <p class="subtitle">Combina los n√∫meros para llegar al objetivo</p>
        </div>
        
        <div class="instructions">
            <h3>üéØ C√≥mo jugar:</h3>
            <p><strong>Escritorio:</strong> Arrastra cualquier ficha en la direcci√≥n que quieres mover.</p>
            <p><strong>M√≥vil:</strong> Desliza en cualquier direcci√≥n.</p>
            <p><strong>Objetivo:</strong> Combina fichas iguales para crear n√∫meros m√°s grandes.</p>
        </div>
        
        <div class="game-info">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Puntuaci√≥n</div>
                    <div class="stat-value" id="currentScore">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Mejor</div>
                    <div class="stat-value" id="bestScore">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Objetivo</div>
                    <div class="stat-value" id="targetValue">2048</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Movimientos</div>
                    <div class="stat-value" id="moveCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Deshaceres</div>
                    <div class="stat-value" id="undoCount">3</div>
                </div>
            </div>
            
            <div class="mode-selector" id="modeSelector">
                <button class="mode-btn" data-size="3" data-target="512">üü® 3√ó3 (512)</button>
                <button class="mode-btn active" data-size="4" data-target="2048">üü¶ 4√ó4 (2048)</button>
                <button class="mode-btn" data-size="5" data-target="4096">üü© 5√ó5 (4096)</button>
                <button class="mode-btn" data-size="6" data-target="8192">üü™ 6√ó6 (8192)</button>
            </div>
            
            <div class="difficulty-toggle">
                <span>Normal</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="progressiveMode">
                    <span class="slider"></span>
                </label>
                <span>üìà Progresivo</span>
            </div>
        </div>
        
        <div class="game-board">
            <div class="grid grid-4x4" id="gameGrid">
                <!-- Se genera din√°micamente -->
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="newGame()">üéÆ Nuevo Juego</button>
            <button class="btn btn-secondary" onclick="undoMove()" id="undoBtn">‚Ü∂ Deshacer</button>
            <button class="btn btn-success" onclick="showHelp()">‚ùì Ayuda</button>
            <button class="btn btn-danger" onclick="confirmBack()">üè† Men√∫</button>
        </div>
    </div>
    
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2 id="gameOverTitle">üéâ ¬°Objetivo Alcanzado!</h2>
            <p id="gameOverMessage">¬°Has llegado a 2048!</p>
            <button class="btn btn-primary" onclick="continueGame()">
                ‚ñ∂Ô∏è Continuar Jugando
            </button>
            <button class="btn btn-secondary" onclick="newGame(); hideGameOver()">
                üéÆ Nuevo Juego
            </button>
        </div>
    </div>
    
    <div class="help-modal" id="helpModal">
        <div class="help-content">
            <h2>üéÆ Gu√≠a Completa de 2048</h2>
            
            <div class="help-section">
                <h3>üéØ Objetivo del Juego</h3>
                <p>Combina fichas con el mismo n√∫mero para crear fichas de mayor valor. El objetivo es llegar al n√∫mero meta seg√∫n el modo de juego.</p>
            </div>
            
            <div class="help-section">
                <h3>üïπÔ∏è Controles</h3>
                <div class="controls-demo">
                    <p><strong>Escritorio:</strong></p>
                    <p>Arrastra cualquier ficha en la direcci√≥n que quieres mover</p>
                    <div class="keyboard-keys">
                        <div class="key" style="background: linear-gradient(45deg, #00F5FF, #20B2AA); color: #1e3c72;">üëÜ Drag</div>
                    </div>
                    <p><strong>M√≥vil:</strong> Desliza en cualquier direcci√≥n</p>
                </div>
            </div>
            
            <div class="help-section">
                <h3>üéÆ Modos de Juego</h3>
                <ul>
                    <li><strong>üü® 3√ó3 (512):</strong> Tablero compacto, objetivo 512</li>
                    <li><strong>üü¶ 4√ó4 (2048):</strong> Modo cl√°sico, objetivo 2048</li>
                    <li><strong>üü© 5√ó5 (4096):</strong> Tablero grande, objetivo 4096</li>
                    <li><strong>üü™ 6√ó6 (8192):</strong> Modo experto, objetivo 8192</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3>üìà Modo Progresivo</h3>
                <p>En modo progresivo, aparecen fichas de mayor valor (4s) con m√°s frecuencia, haciendo el juego m√°s desafiante pero tambi√©n m√°s din√°mico.</p>
            </div>
            
            <div class="help-section">
                <h3>‚Ü∂ Sistema de Deshacer</h3>
                <p>Tienes <strong>3 movimientos de deshacer</strong> por partida. √ösalos sabiamente para corregir errores estrat√©gicos.</p>
            </div>
            
            <div class="help-section">
                <h3>üí° Estrategias</h3>
                <ul>
                    <li>Mant√©n las fichas m√°s altas en una esquina</li>
                    <li>Construye n√∫meros en orden ascendente</li>
                    <li>Evita mover en la direcci√≥n de tu esquina principal</li>
                    <li>Siempre ten un plan para las pr√≥ximas combinaciones</li>
                </ul>
            </div>
            
            <button class="close-help" onclick="hideHelp()">‚úÖ ¬°Entendido!</button>
        </div>
    </div>
    
    <!-- Modal de confirmaci√≥n -->
    <div class="help-modal" id="confirmModal">
        <div class="help-content" style="max-width: 400px;">
            <h2 id="confirmTitle">üè† Volver al Men√∫</h2>
            <div class="help-section">
                <p id="confirmMessage">¬øSeguro que quieres volver al men√∫ principal? Se perder√° la partida actual.</p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="close-help" onclick="confirmGoBack()" style="background: linear-gradient(45deg, #4CAF50, #66BB6A);">‚úÖ S√≠, Volver</button>
                <button class="close-help" onclick="hideConfirm()" style="background: linear-gradient(45deg, #FF6B6B, #FF8A80);">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        class Game2048 {
            constructor() {
                this.size = 4;
                this.target = 2048;
                this.grid = [];
                this.score = 0;
                this.moves = 0;
                this.undoStack = [];
                this.undoCount = 3;
                this.progressive = false;
                this.gameWon = false;
                this.gameEnded = false;
                this.animationDelay = 150;
                
                this.gameData = this.loadGameData();
                this.initGame();
                this.setupEventListeners();
            }
            
            loadGameData() {
                const saved = localStorage.getItem('game2048-progress');
                if (saved) {
                    return JSON.parse(saved);
                }
                return {
                    bestScores: {},
                    gamesPlayed: 0,
                    totalScore: 0
                };
            }
            
            saveGameData() {
                const key = `${this.size}x${this.size}_${this.progressive ? 'progressive' : 'normal'}`;
                if (!this.gameData.bestScores[key] || this.score > this.gameData.bestScores[key]) {
                    this.gameData.bestScores[key] = this.score;
                }
                
                this.gameData.gamesPlayed++;
                this.gameData.totalScore += this.score;
                
                localStorage.setItem('game2048-progress', JSON.stringify(this.gameData));
            }
            
            initGame() {
                this.createGrid();
                this.addRandomTile();
                this.addRandomTile();
                this.updateDisplay();
                this.updateUI();
            }
            
            createGrid() {
                this.grid = Array(this.size).fill().map(() => Array(this.size).fill(0));
                this.renderGrid();
            }
            
            renderGrid() {
                const gameGrid = document.getElementById('gameGrid');
                gameGrid.innerHTML = '';
                gameGrid.className = `grid grid-${this.size}x${this.size}`;
                
                // Crear celdas de fondo
                for (let i = 0; i < this.size * this.size; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    gameGrid.appendChild(cell);
                }
                
                this.updateDisplay();
            }
            
            addRandomTile() {
                const emptyCells = [];
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (this.grid[r][c] === 0) {
                            emptyCells.push({ r, c });
                        }
                    }
                }
                
                if (emptyCells.length > 0) {
                    const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    
                    // En modo progresivo, mayor probabilidad de 4s
                    const value = this.progressive ? 
                        (Math.random() < 0.3 ? 4 : 2) : 
                        (Math.random() < 0.1 ? 4 : 2);
                    
                    this.grid[randomCell.r][randomCell.c] = value;
                    this.createTileElement(randomCell.r, randomCell.c, value, true);
                }
            }
            
            createTileElement(row, col, value, isNew = false) {
                const gameGrid = document.getElementById('gameGrid');
                const tile = document.createElement('div');
                tile.className = `tile tile-${value}`;
                if (isNew) tile.classList.add('new');
                
                tile.textContent = value;
                tile.style.gridRow = row + 1;
                tile.style.gridColumn = col + 1;
                tile.draggable = true;
                
                // Establecer dimensiones seg√∫n el tama√±o del grid y viewport
                const isMobile = window.innerWidth <= 768;
                const isSmallMobile = window.innerWidth <= 480;
                
                let sizes;
                if (isSmallMobile) {
                    sizes = {
                        3: { width: '60px', height: '60px' },
                        4: { width: '50px', height: '50px' },
                        5: { width: '42px', height: '42px' },
                        6: { width: '35px', height: '35px' }
                    };
                } else if (isMobile) {
                    sizes = {
                        3: { width: '70px', height: '70px' },
                        4: { width: '60px', height: '60px' },
                        5: { width: '50px', height: '50px' },
                        6: { width: '42px', height: '42px' }
                    };
                } else {
                    sizes = {
                        3: { width: '80px', height: '80px' },
                        4: { width: '70px', height: '70px' },
                        5: { width: '60px', height: '60px' },
                        6: { width: '50px', height: '50px' }
                    };
                }
                
                const size = sizes[this.size];
                tile.style.width = size.width;
                tile.style.height = size.height;
                
                gameGrid.appendChild(tile);
                
                return tile;
            }
            
            updateDisplay() {
                const gameGrid = document.getElementById('gameGrid');
                const existingTiles = gameGrid.querySelectorAll('.tile');
                existingTiles.forEach(tile => tile.remove());
                
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (this.grid[r][c] !== 0) {
                            this.createTileElement(r, c, this.grid[r][c]);
                        }
                    }
                }
            }
            
            saveState() {
                if (this.undoStack.length >= 10) {
                    this.undoStack.shift(); // Mantener solo las √∫ltimas 10 jugadas
                }
                
                this.undoStack.push({
                    grid: this.grid.map(row => [...row]),
                    score: this.score,
                    moves: this.moves
                });
            }
            
            move(direction) {
                if (this.gameEnded) return false;
                
                this.saveState();
                
                const previousGrid = this.grid.map(row => [...row]);
                let moved = false;
                let scoreIncrease = 0;
                
                const vectors = {
                    up: { r: -1, c: 0 },
                    down: { r: 1, c: 0 },
                    left: { r: 0, c: -1 },
                    right: { r: 0, c: 1 }
                };
                
                const vector = vectors[direction];
                const traversals = this.buildTraversals(vector);
                
                // Limpiar flags de fusi√≥n
                const merged = Array(this.size).fill().map(() => Array(this.size).fill(false));
                
                traversals.x.forEach(x => {
                    traversals.y.forEach(y => {
                        const cell = { r: x, c: y };
                        const tile = this.grid[cell.r][cell.c];
                        
                        if (tile !== 0) {
                            const positions = this.findFarthestPosition(cell, vector);
                            const next = positions.next;
                            
                            if (next && this.withinBounds(next) && this.grid[next.r][next.c] === tile && !merged[next.r][next.c]) {
                                // Fusi√≥n
                                const newValue = tile * 2;
                                this.grid[next.r][next.c] = newValue;
                                this.grid[cell.r][cell.c] = 0;
                                
                                merged[next.r][next.c] = true;
                                scoreIncrease += newValue;
                                moved = true;
                                
                                // Crear animaci√≥n de fusi√≥n
                                setTimeout(() => {
                                    const tileElement = document.querySelector(`[style*="grid-row: ${next.r + 1}"][style*="grid-column: ${next.c + 1}"]`);
                                    if (tileElement) {
                                        tileElement.classList.add('merged');
                                    }
                                }, this.animationDelay);
                                
                            } else {
                                // Movimiento simple
                                const farthest = positions.farthest;
                                if (farthest.r !== cell.r || farthest.c !== cell.c) {
                                    this.grid[farthest.r][farthest.c] = tile;
                                    this.grid[cell.r][cell.c] = 0;
                                    moved = true;
                                }
                            }
                        }
                    });
                });
                
                if (moved) {
                    this.score += scoreIncrease;
                    this.moves++;
                    
                    setTimeout(() => {
                        this.updateDisplay();
                        this.addRandomTile();
                        this.updateUI();
                        
                        if (this.hasWon() && !this.gameWon) {
                            this.gameWon = true;
                            this.showGameOver(true);
                        } else if (this.isGameOver()) {
                            this.gameEnded = true;
                            this.showGameOver(false);
                        }
                    }, this.animationDelay);
                    
                    this.updateDisplay();
                } else {
                    // Revertir estado si no hubo movimiento
                    this.undoStack.pop();
                }
                
                return moved;
            }
            
            buildTraversals(vector) {
                const traversals = { x: [], y: [] };
                
                for (let pos = 0; pos < this.size; pos++) {
                    traversals.x.push(pos);
                    traversals.y.push(pos);
                }
                
                // Siempre atravesar desde la direcci√≥n m√°s lejana
                if (vector.r === 1) traversals.x = traversals.x.reverse();
                if (vector.c === 1) traversals.y = traversals.y.reverse();
                
                return traversals;
            }
            
            findFarthestPosition(cell, vector) {
                let previous;
                
                do {
                    previous = cell;
                    cell = { r: previous.r + vector.r, c: previous.c + vector.c };
                } while (this.withinBounds(cell) && this.cellAvailable(cell));
                
                return {
                    farthest: previous,
                    next: cell
                };
            }
            
            withinBounds(position) {
                return position.r >= 0 && position.r < this.size &&
                       position.c >= 0 && position.c < this.size;
            }
            
            cellAvailable(cell) {
                return this.grid[cell.r][cell.c] === 0;
            }
            
            hasWon() {
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (this.grid[r][c] >= this.target) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            isGameOver() {
                // Verificar si hay celdas vac√≠as
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (this.grid[r][c] === 0) return false;
                    }
                }
                
                // Verificar si hay movimientos posibles
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        const current = this.grid[r][c];
                        
                        // Verificar adyacentes
                        const directions = [[-1, 0], [1, 0], [0, -1], [0, 1]];
                        for (const [dr, dc] of directions) {
                            const nr = r + dr;
                            const nc = c + dc;
                            
                            if (nr >= 0 && nr < this.size && nc >= 0 && nc < this.size) {
                                if (this.grid[nr][nc] === current) {
                                    return false;
                                }
                            }
                        }
                    }
                }
                
                return true;
            }
            
            undoMove() {
                if (this.undoStack.length > 0 && this.undoCount > 0) {
                    const previousState = this.undoStack.pop();
                    this.grid = previousState.grid;
                    this.score = previousState.score;
                    this.moves = previousState.moves;
                    this.undoCount--;
                    
                    this.updateDisplay();
                    this.updateUI();
                }
            }
            
            setupEventListeners() {
                // Controles t√°ctiles
                this.setupTouchControls();
                
                // Controles de drag and drop
                this.setupDragControls();
                
                // Selectores de modo
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        this.size = parseInt(btn.dataset.size);
                        this.target = parseInt(btn.dataset.target);
                        this.newGame();
                    });
                });
                
                // Toggle modo progresivo
                document.getElementById('progressiveMode').addEventListener('change', (e) => {
                    this.progressive = e.target.checked;
                    this.newGame();
                });
                
                // Cerrar modales
                document.getElementById('helpModal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        hideHelp();
                    }
                });
                
                // Cerrar modal de confirmaci√≥n al hacer clic fuera
                document.getElementById('confirmModal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        hideConfirm();
                    }
                });
            }
            
            setupTouchControls() {
                const gameGrid = document.getElementById('gameGrid');
                let startX, startY;
                
                gameGrid.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                });
                
                gameGrid.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (!startX || !startY) return;
                    
                    const touch = e.changedTouches[0];
                    const diffX = touch.clientX - startX;
                    const diffY = touch.clientY - startY;
                    
                    const minSwipe = 30;
                    
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        if (Math.abs(diffX) > minSwipe) {
                            this.move(diffX > 0 ? 'right' : 'left');
                        }
                    } else {
                        if (Math.abs(diffY) > minSwipe) {
                            this.move(diffY > 0 ? 'down' : 'up');
                        }
                    }
                    
                    startX = startY = null;
                });
            }
            
            setupDragControls() {
                const gameGrid = document.getElementById('gameGrid');
                let dragStartX, dragStartY;
                let isDragging = false;
                
                // Agregar cursor de drag al tablero
                gameGrid.style.cursor = 'grab';
                
                // Drag desde cualquier parte del tablero
                gameGrid.addEventListener('mousedown', (e) => {
                    if (this.gameEnded) return;
                    
                    isDragging = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    e.preventDefault();
                    
                    gameGrid.style.cursor = 'grabbing';
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                });
                
                document.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    gameGrid.style.cursor = 'grab';
                    
                    const diffX = e.clientX - dragStartX;
                    const diffY = e.clientY - dragStartY;
                    
                    const minDrag = 20; // Reducir threshold para mayor sensibilidad
                    
                    console.log('Drag detected - X:', diffX, 'Y:', diffY); // Debug
                    
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        // Movimiento horizontal predominante
                        if (Math.abs(diffX) > minDrag) {
                            const direction = diffX > 0 ? 'right' : 'left';
                            console.log('Moving:', direction);
                            this.move(direction);
                        }
                    } else {
                        // Movimiento vertical predominante
                        if (Math.abs(diffY) > minDrag) {
                            const direction = diffY > 0 ? 'down' : 'up';
                            console.log('Moving:', direction);
                            this.move(direction);
                        }
                    }
                });
                
                // Cancelar drag si el mouse sale del √°rea
                gameGrid.addEventListener('mouseleave', () => {
                    if (isDragging) {
                        isDragging = false;
                        gameGrid.style.cursor = 'grab';
                    }
                });
            }
            
            updateUI() {
                document.getElementById('currentScore').textContent = this.score;
                document.getElementById('targetValue').textContent = this.target;
                document.getElementById('moveCount').textContent = this.moves;
                document.getElementById('undoCount').textContent = this.undoCount;
                
                // Mejor puntuaci√≥n
                const key = `${this.size}x${this.size}_${this.progressive ? 'progressive' : 'normal'}`;
                const bestScore = this.gameData.bestScores[key] || 0;
                document.getElementById('bestScore').textContent = Math.max(bestScore, this.score);
                
                // Estado del bot√≥n deshacer
                const undoBtn = document.getElementById('undoBtn');
                undoBtn.disabled = this.undoCount === 0 || this.undoStack.length === 0;
            }
            
            showGameOver(won) {
                const modal = document.getElementById('gameOver');
                const title = document.getElementById('gameOverTitle');
                const message = document.getElementById('gameOverMessage');
                
                if (won) {
                    title.textContent = 'üéâ ¬°Objetivo Alcanzado!';
                    message.textContent = `¬°Has llegado a ${this.target}! Puntuaci√≥n: ${this.score}`;
                } else {
                    title.textContent = 'üòî Juego Terminado';
                    message.textContent = `No hay m√°s movimientos. Puntuaci√≥n final: ${this.score}`;
                    
                    // Ocultar bot√≥n continuar si perdi√≥
                    const continueBtn = modal.querySelector('button');
                    continueBtn.style.display = 'none';
                }
                
                this.saveGameData();
                modal.classList.add('show');
            }
            
            newGame() {
                this.grid = [];
                this.score = 0;
                this.moves = 0;
                this.undoStack = [];
                this.undoCount = 3;
                this.gameWon = false;
                this.gameEnded = false;
                
                this.initGame();
                hideGameOver();
            }
        }
        
        // Funciones globales
        let game;
        
        function initGame() {
            game = new Game2048();
        }
        
        function newGame() {
            game.newGame();
        }
        
        function undoMove() {
            game.undoMove();
        }
        
        function continueGame() {
            game.gameWon = true; // Marcar como ganado pero permitir continuar
            hideGameOver();
        }
        
        function hideGameOver() {
            document.getElementById('gameOver').classList.remove('show');
        }
        
        function showHelp() {
            document.getElementById('helpModal').classList.add('show');
        }
        
        function hideHelp() {
            document.getElementById('helpModal').classList.remove('show');
        }
        
        function showConfirm() {
            document.getElementById('confirmModal').classList.add('show');
        }
        
        function hideConfirm() {
            document.getElementById('confirmModal').classList.remove('show');
        }
        
        function confirmGoBack() {
            window.location.href = '../index.html';
        }
        
        function confirmBack() {
            if (game.moves > 0 && !game.gameEnded) {
                showConfirm();
            } else {
                window.location.href = '../index.html';
            }
        }
        
        // Inicializar cuando la p√°gina carga
        document.addEventListener('DOMContentLoaded', initGame);
        
        // Prevenir scroll en m√≥viles
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>